#!/usr/bin/env bash
set -eou pipefail

resources_dir="usr/local/resources"
src_dir="usr/local/src"

setup(){
  source "${src_dir}/util"
  source "${src_dir}/athena"

  setup_email

  mkdir -p /out
}

_report(){
  report="$1"

  psql "$db_uri" --html -f "${resources_dir}/${report}.sql" >"/out/${report}"     # html
  psql "$db_uri" -AF',' -f "${resources_dir}/${report}.sql" >"/out/${report}.csv" # csv

  email $report
}

_report_athena(){
  report="$1"

  athena "$(cat ${resources_dir}/${report}_athena.sql)" >"/out/${report}" # html...
  athena "$(cat ${resources_dir}/${report}_athena.sql)" >"/out/${report}" # csv

  email $report
}

_portfolio(){
  exit_if weekend && \
    exit_if holiday

  set +u
  if [[ ! -z $db_uri ]]; then
    _report portfolio
  else
    _report_athena portfolio
  fi
  set -u
}

setup \
  && _portfolio
