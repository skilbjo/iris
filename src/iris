#!/usr/bin/env bash
set -eou pipefail

resources_dir="usr/local/resources"
src_dir="usr/local/src"

setup(){
  export email="${_email}"

  source "${src_dir}/util"
  source "${src_dir}/athena"

  mkdir -p /out
}

_report(){
  report="$1"

  psql "$db_uri" --html -f "${resources_dir}/${report}.sql" >"/out/${report}"     # html
  psql "$db_uri" -AF',' -f "${resources_dir}/${report}.sql" >"/out/${report}.csv" # csv

  email $report
}

_portfolio(){
  setup_email

  #_report logs # this report is a little annoying

  _report portfolio
  _report performance
}

_report_athena(){
  report="$1"

  query "$(cat ${resources_dir}/${report}_athena.sql)" >"/out/${report}.csv" # csv
  csv_to_html $report >"/out/${report}"                                      # html

  email_aws $report
}

_portfolio_aws(){
  setup_aws

  _report_athena portfolio
}

setup
set +u; \
  if [[ ! -z $db_uri ]]; then \
    _portfolio && \
      ping_healthchecks "$healthchecks_io_iris"; \
  else \
    _portfolio_aws; \
  fi; \
set -u
