#!/usr/bin/env bash
set -eou pipefail

setup_email(){
  echo set from = "${email}"                          >>/root/.muttrc \
    && echo set realname = "Iris"                     >>/root/.muttrc \
    && echo set imap_user = "${email}"                >>/root/.muttrc \
    && echo set imap_pass = "${email_pw}"             >>/root/.muttrc \
    && echo set folder = "imaps://imap.gmail.com:993" >>/root/.muttrc \
    && echo set spoolfile = "+INBOX"                  >>/root/.muttrc \
    && echo set postponed ="+[Gmail]/Drafts"          >>/root/.muttrc \
    && echo set header_cache =~/.mutt/cache/headers   >>/root/.muttrc \
    && echo set message_cachedir =~/.mutt/cache/bodies  >>/root/.muttrc \
    && echo set certificate_file =~/.mutt/certificates  >>/root/.muttrc \
    && echo set smtp_url = "smtps://$(echo $email | sed 's/@.*//')@smtp.gmail.com:465/"  >>/root/.muttrc \
    && echo set smtp_pass = "${email_pw}"             >>/root/.muttrc \
    && echo set move = no                             >>/root/.muttrc \
    && echo set imap_keepalive = 900                  >>/root/.muttrc \
    && chown -R postfix /var/spool/postfix/ \
    && chown root /var/spool/postfix/ \
    && chown root /var/spool/postfix/pid \
    && postmap /etc/postfix/generic

  set +e
  postfix start || echo 'Postfix already running'
  set -e
  sleep 3
}

email() {
  local report="$1"

  echo "Iris report for $(date -I): $(cat "/out/${report}")" | \
    mutt -e 'set content_type=text/html' \
      -s "Iris report for $report on $(date -I)" \
      -a "/out/${report}.csv" \
      -- $email
  sleep 5
}

exit_if(){
  case "$@" in
    weekend )
      case "$(date +%a)" in
        Sat | Sun)
          exit 0 ;; # silently exit - we don't care if not a weekday
        * )
          ;;
      esac
      ;;
    holiday )
      if [[ "True" == $(psql $db_uri -tc 'select "official_public_holiday?" from dw.date_dim where date = now()::date;' | awk '{$1=$1};1' | head -n1) ]]; then
        exit 0
      fi
      ;;
    *)
      ;;
  esac
}
