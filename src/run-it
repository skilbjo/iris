#!/usr/bin/env bash
set -eou pipefail

dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
resources_dir="${dir}/../resources/"
tmp_dir="/tmp"
set +u; task="$1"; set -u

setup(){
  local src_dir="${dir}"

  source "${dir}/email"
  source "${dir}/util"

  export email="${_email}"

  if [[ $(whoami) == 'root' ]]; then
    source "${src_dir}/athena"
    add_aws_vars
  elif [[ $(whoami) == 'sbx_'* ]]; then
    source "${src_dir}/athena"
    add_aws_vars
  elif [[ $(whoami) == 'skilbjo' ]]; then
    source "/Users/skilbjo/dev/engineering/src/athena.user"
  else
    >&2 echo "user is: $(whoami), add to setup fn"
  fi

  mkdir -p "${tmp_dir}/dw" && mkdir -p "${tmp_dir}/athena"
}

_report(){
  local report="$1"
  local user="$2"
  local distro_list="$3"

  local sql="$(cat "${resources_dir}/dw/${report}.sql" | sed "s/:user/${user}/")"

  # csv
  psql "$db_uri" \
    -AF',' \
    --pset footer \
    -c "$sql" \
    >"${tmp_dir}/${report}.csv"

  # html
  psql "$db_uri" \
    --html \
    -c "$sql" \
    >"${tmp_dir}/${report}.html"

  email "$report" "$distro_list"
}

_report_athena(){
  local report="$1"
  local user="$2"
  local distro_list="$3"

  local sql="$(cat "${resources_dir}/athena/${report}_athena.sql" | \
    sed "s/:user/${user}/")"

  # csv
  query "$sql" >"${tmp_dir}/${report}.csv"

  # html
  csv_to_html "$report" >"${tmp_dir}/${report}.html"

  email "$report" "$distro_list"
}

daily(){
  set +u; local db="$db_uri"; set -u
    if [[ ! -z $db ]]; then
      _report portfolio 'skilbjo' "$email" && \
        ping_healthchecks "$healthchecks_io_iris";
    else
      _report_athena portfolio 'skilbjo' "$email"
    fi;
}

weekly(){
  set +u; local db="$db_uri"; set -u
    if [[ ! -z $db ]]; then
      _report asset_type 'skilbjo' "$email" && \
        _report location 'skilbjo' "$email" && \
        _report capitalization 'skilbjo' "$email" && \
        _report investment_style 'skilbjo' "$email"
    else
      _report_athena portfolio 'skilbjo' "$email"
    fi;
}

testing(){
  set +u; local db="$db_uri"; set -u

  if [[ ! -z $db ]]; then
    _report        portfolio 'skilbjo' "$email"
  else
    _report_athena portfolio 'skilbjo' "$email"
  fi
}

setup

case "$task" in
  daily )
    daily ;;
  weekly )
    weekly ;;
  testing )
    testing ;;
  * )
    echo 'in src/run-it, no args provided' && exit 1 ;;
esac
