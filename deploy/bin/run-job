#!/usr/bin/env bash
set -eou pipefail

dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../../" && pwd )" && cd "$dir"
src_dir="${dir}/src"
set +u; _job="$1"; set -u
cmd=''

update_crond(){
  case "$(uname)" in
    ('FreeBSD') sed -i '' $'1i\\\n SHELL="/usr/local/bin/bash"\n' "${dir}/deploy/tasks/crontab"
                sed -i '' $'1i\\\n cmd="deploy/bin/run-job"\n'    "${dir}/deploy/tasks/crontab" ;;
  esac
  sudo bash -c "cat ${dir}/deploy/tasks/crontab >/etc/cron.d/${app}"
}

prereqs(){
  if [[ $(whoami) == 'root' ]]; then
    case $(uname -m) in
      arm* )
        deploy_dir='/usr/local/deploy/bin'
        set +e; eval "${deploy_dir}/apk-arm"; update-ca-certificates; apk fix || echo 'Unable to reach apk...'; set -e; # set +e when apk not available
    esac
  fi
}

if [[ $(uname) == 'FreeBSD' ]]; then git pull -f; update_crond; fi

case "$_job" in
  daily )
    cmd="${src_dir}/run-it daily" ;;
  weekly )
    cmd="${src_dir}/run-it weekly" ;;
  * ) echo 'No args provided' && exit 1 ;;
esac

prereqs && \
  eval "$cmd"
